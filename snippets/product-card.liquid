{% comment %}
  Snippet: product-card.liquid
  
  Description: Carte produit réutilisable pour Lunetier & Co
  Fonctionnalités:
  - Image principale + image au survol
  - Badge (Nouveau, Promo, Épuisé)
  - Bouton slide-up
  - Prix avec réduction
  - Quick view optionnel
  - Lazy loading optimisé
  
  Usage:
  {% render 'product-card', 
    product: product,
    show_second_image: true,
    show_badge: true,
    show_vendor: true,
    image_loading: 'lazy'
  %}
  
  Paramètres:
  - product: Objet produit Shopify (required)
  - show_second_image: Afficher 2ème image au hover (default: true)
  - show_badge: Afficher badge Nouveau/Promo (default: true)
  - show_vendor: Afficher la marque/vendor (default: false)
  - show_quick_view: Afficher bouton quick view (default: false)
  - image_loading: 'lazy' ou 'eager' (default: 'lazy')
  - card_class: Classes CSS additionnelles
{% endcomment %}

{% liquid
  assign show_second_image = show_second_image | default: true
  assign show_badge = show_badge | default: true
  assign show_vendor = show_vendor | default: false
  assign show_quick_view = show_quick_view | default: false
  assign image_loading = image_loading | default: 'lazy'
  assign card_class = card_class | default: ''
  
  # Calcul du badge
  assign badge_text = ''
  assign badge_type = ''
  
  if show_badge
    # Vérifier si produit épuisé
    unless product.available
      assign badge_text = 'Épuisé'
      assign badge_type = 'sold-out'
    else
      # Vérifier si en promo
      if product.compare_at_price > product.price
        assign discount_percentage = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price
        assign badge_text = discount_percentage | append: '% OFF'
        assign badge_type = 'sale'
      # Vérifier si nouveau (créé dans les 30 derniers jours)
      else
        assign product_date_ts = product.created_at | date: '%s' | plus: 0
        assign now_ts = 'now' | date: '%s' | plus: 0
        assign new_threshold = now_ts | minus: 2592000
        
        if product.tags contains 'nouveau' or product.tags contains 'new' or product_date_ts > new_threshold
          assign badge_text = 'Nouveau'
          assign badge_type = 'new'
        endif
      endif
    endunless
  endif
  
  # Déterminer les images
  assign main_image = product.featured_media
  assign hover_image = nil
  if show_second_image and product.media.size > 1
    assign hover_image = product.media[1]
  endif
%}

<article class="lunetier-product-card {{ card_class }}" data-product-id="{{ product.id }}">
  <a href="{{ product.url }}" class="lunetier-card-link" aria-label="Voir {{ product.title }}">
    
    {%- comment -%} IMAGE CONTAINER {%- endcomment -%}
    <div class="lunetier-card-image-wrapper">
      
      {%- comment -%} BADGE {%- endcomment -%}
      {% if badge_text != blank %}
        <span class="lunetier-card-badge lunetier-badge-{{ badge_type }}">
          {{ badge_text }}
        </span>
      {% endif %}
      
      {%- comment -%} IMAGE PRINCIPALE {%- endcomment -%}
      {% if main_image != blank %}
        {% render 'responsive-image',
          image: main_image,
          sizes: '(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw',
          loading: image_loading,
          class: 'lunetier-card-img lunetier-card-img-main'
        %}
      {% else %}
        {{ 'product-1' | placeholder_svg_tag: 'lunetier-card-img lunetier-card-img-main' }}
      {% endif %}
      
      {%- comment -%} IMAGE AU SURVOL {%- endcomment -%}
      {% if hover_image != blank %}
        {% render 'responsive-image',
          image: hover_image,
          sizes: '(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw',
          loading: 'lazy',
          class: 'lunetier-card-img lunetier-card-img-hover'
        %}
      {% endif %}
      
      {%- comment -%} SLIDE-UP BUTTON {%- endcomment -%}
      <div class="lunetier-card-btn" role="button" tabindex="-1">
        {% if product.available %}
          {% if show_quick_view %}
            Quick View
          {% else %}
            Voir - {{ product.price | money_without_trailing_zeros }}
          {% endif %}
        {% else %}
          Épuisé
        {% endif %}
      </div>
    </div>
    
    {%- comment -%} INFO CONTAINER {%- endcomment -%}
    <div class="lunetier-card-info">
      <div class="lunetier-card-details">
        <h3 class="lunetier-card-title">{{ product.title }}</h3>
        
        {%- comment -%} VENDOR / TYPE {%- endcomment -%}
        {% if show_vendor %}
          <p class="lunetier-card-meta">
            {{ product.vendor | default: product.type }}
          </p>
        {% endif %}
        
        {%- comment -%} AVIS (si app d'avis installée) {%- endcomment -%}
        {% comment %}
        <div class="lunetier-card-rating">
          {%- render 'product-rating', product: product -%}
        </div>
        {% endcomment %}
      </div>
      
      {%- comment -%} PRIX {%- endcomment -%}
      <div class="lunetier-card-price-wrapper">
        {% if product.compare_at_price > product.price %}
          <span class="lunetier-card-price lunetier-card-price-sale">
            {{ product.price | money_without_trailing_zeros }}
          </span>
          <span class="lunetier-card-price-compare">
            {{ product.compare_at_price | money_without_trailing_zeros }}
          </span>
        {% else %}
          <span class="lunetier-card-price">
            {{ product.price | money_without_trailing_zeros }}
          </span>
        {% endif %}
      </div>
    </div>
    
  </a>
  
  {%- comment -%} QUICK VIEW MODAL (si activé) {%- endcomment -%}
  {% if show_quick_view %}
    {%- comment -%}
    TODO: Implémenter modal quick view avec AJAX
    <button class="lunetier-quick-view-btn" 
            data-product-handle="{{ product.handle }}"
            aria-label="Aperçu rapide de {{ product.title }}">
      <svg>...</svg>
    </button>
    {%- endcomment -%}
  {% endif %}
</article>
