{% comment %}
  Header Section "Lunetier" - With Predictive Search
  Desktop Mode: PERFECT
  Mobile Mode: Functional drawer + Search at top
{% endcomment %}

<div class="lunetier-header-wrapper" id="HeaderWrapper-{{ section.id }}">
  <div class="lunetier-container">
    
    <!-- LOGO -->
    <a href="{{ routes.root_url }}" class="lunetier-logo" aria-label="Back to home">
      {%- if section.settings.logo != blank -%}
        {% render 'responsive-image',
          image: section.settings.logo,
          sizes: '(min-width: 768px) 150px, 100px',
          loading: 'eager',
          class: 'lunetier-logo-img',
          alt: section.settings.logo.alt | default: shop.name
        %}
      {%- else -%}
        {{ shop.name }}
      {%- endif -%}
    </a>

    <div class="lunetier-actions">
      <!-- DESKTOP MENU -->
      <nav class="lunetier-nav" role="navigation" aria-label="Main menu">
        {%- for link in section.settings.menu.links -%}
          <a href="{{ link.url }}" class="lunetier-link">{{ link.title }}</a>
        {%- endfor -%}
      </nav>

      <!-- SEARCH BUTTON (Desktop + Mobile) -->
      <button class="lunetier-icon-btn" id="SearchToggle-{{ section.id }}" aria-label="Open search" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>

      <!-- ACCOUNT ICON (Desktop only) -->
      <a href="{{ routes.account_url }}" class="lunetier-icon-btn lunetier-account-desktop" aria-label="My account">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </a>

      <!-- CART ICON (Desktop + Mobile) -->
      <a href="{{ routes.cart_url }}" class="lunetier-icon-btn" id="cart-icon-bubble" aria-label="Cart ({{ cart.item_count }} item{% if cart.item_count != 1 %}s{% endif %})">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        {%- if cart.item_count > 0 -%}
          <span class="lunetier-cart-count">{{ cart.item_count }}</span>
        {%- endif -%}
      </a>

      <!-- MOBILE BURGER TRIGGER -->
      <button class="lunetier-icon-btn lunetier-mobile-toggle" aria-label="Open menu" id="MobileMenuTrigger-{{ section.id }}">
         <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
         </svg>
      </button>
    </div>

  </div>
</div>

<!-- SEARCH BAR SLIDE-DOWN (Desktop + Mobile) -->
<div class="lunetier-search-bar" id="SearchBar-{{ section.id }}" role="search">
  <div class="lunetier-search-wrapper">
    <!-- HEADER -->
    <div class="lunetier-search-header">
      <h2 class="lunetier-search-title">Search</h2>
      <button type="button" class="lunetier-search-close" id="SearchClose-{{ section.id }}" aria-label="Close search">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <!-- SEARCH FORM -->
    <div class="lunetier-search-container">
      <form action="{{ routes.search_url }}" method="get" class="lunetier-search-form">
        <div class="lunetier-search-input-wrapper">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="lunetier-search-icon">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input
            type="text"
            name="q"
            placeholder="Search for a product..."
            class="lunetier-search-input"
            id="SearchInput-{{ section.id }}"
            autocomplete="off"
            aria-label="Search field"
          >
          <input type="hidden" name="type" value="product">
        </div>
      </form>
    </div>
    
    <!-- PREDICTIVE SEARCH RESULTS -->
    {% render 'predictive-search', section_id: section.id %}
  </div>
</div>

<!-- MOBILE DRAWER OVERLAY -->
<div class="lunetier-drawer-overlay" id="MobileDrawerOverlay-{{ section.id }}"></div>

<!-- MOBILE DRAWER -->
<div class="lunetier-drawer" id="MobileDrawer-{{ section.id }}">
  <div class="lunetier-drawer-header">
    <span class="lunetier-drawer-title">Menu</span>
    <button type="button" class="lunetier-drawer-close" id="MobileDrawerClose-{{ section.id }}" aria-label="Close menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  
  <div class="lunetier-drawer-content">
    <!-- NAVIGATION LINKS -->
    <nav class="lunetier-drawer-nav">
      {%- for link in section.settings.menu.links -%}
        <a href="{{ link.url }}" class="lunetier-drawer-link">{{ link.title }}</a>
      {%- endfor -%}
    </nav>

    <!-- DIVIDER -->
    <div class="lunetier-drawer-divider"></div>

    <!-- SECONDARY LINKS -->
    <div class="lunetier-drawer-secondary">
      <a href="{{ routes.account_url }}" class="lunetier-drawer-secondary-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>My Account</span>
      </a>

      {% if shop.customer_accounts_enabled %}
        {% if customer %}
          <a href="{{ routes.account_logout_url }}" class="lunetier-drawer-secondary-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Logout</span>
          </a>
        {% else %}
          <a href="{{ routes.account_login_url }}" class="lunetier-drawer-secondary-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
              <polyline points="10 17 15 12 10 7"></polyline>
              <line x1="15" y1="12" x2="3" y2="12"></line>
            </svg>
            <span>Login</span>
          </a>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<!-- JAVASCRIPT -->
<script>
(function() {
  'use strict';
  
  const sectionId = '{{ section.id }}';
  const header = document.getElementById('HeaderWrapper-' + sectionId);
  const searchBar = document.getElementById('SearchBar-' + sectionId);
  const searchToggle = document.getElementById('SearchToggle-' + sectionId);
  const searchClose = document.getElementById('SearchClose-' + sectionId);
  const searchInput = document.getElementById('SearchInput-' + sectionId);
  const burgerBtn = document.getElementById('MobileMenuTrigger-' + sectionId);
  const drawer = document.getElementById('MobileDrawer-' + sectionId);
  const overlay = document.getElementById('MobileDrawerOverlay-' + sectionId);
  const closeBtn = document.getElementById('MobileDrawerClose-' + sectionId);

  // === SCROLL HEADER ===
  let ticking = false;
  function updateHeader() {
    if (window.scrollY > 50) {
      header.classList.add('is-scrolled');
    } else {
      header.classList.remove('is-scrolled');
    }
    ticking = false;
  }

  window.addEventListener('scroll', function() {
    if (!ticking) {
      window.requestAnimationFrame(updateHeader);
      ticking = true;
    }
  }, { passive: true });

  // === SEARCH ===
  if (searchToggle && searchBar && searchClose && searchInput) {
    function openSearch() {
      searchBar.classList.add('is-open');
      searchToggle.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
      setTimeout(function() {
        searchInput.focus();
      }, 300);
    }

    function closeSearch() {
      searchBar.classList.remove('is-open');
      searchToggle.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
      searchInput.value = '';
      // Clear results
      const resultsEl = document.getElementById('PredictiveSearchResults-' + sectionId);
      if (resultsEl) {
        resultsEl.classList.remove('is-visible');
        resultsEl.innerHTML = '';
      }
    }

    searchToggle.addEventListener('click', function(e) {
      e.preventDefault();
      if (searchBar.classList.contains('is-open')) {
        closeSearch();
      } else {
        openSearch();
      }
    });

    searchClose.addEventListener('click', function(e) {
      e.preventDefault();
      closeSearch();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && searchBar.classList.contains('is-open')) {
        closeSearch();
      }
    });
  }

  // === DRAWER ===
  if (burgerBtn && drawer && overlay && closeBtn) {
    
    function openDrawer() {
      drawer.classList.add('is-open');
      overlay.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }

    function closeDrawer() {
      drawer.classList.remove('is-open');
      overlay.classList.remove('is-open');
      document.body.style.overflow = '';
    }

    burgerBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      openDrawer();
    });

    closeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeDrawer();
    });

    overlay.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeDrawer();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && drawer.classList.contains('is-open')) {
        closeDrawer();
      }
    });
  }

  updateHeader();
})();
</script>

{% schema %}
{
  "name": "Header Lunetier",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo Image"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 50,
      "max": 250,
      "step": 10,
      "default": 100,
      "unit": "px",
      "label": "Logo width"
    },
    {
      "type": "link_list",
      "id": "menu",
      "default": "main-menu",
      "label": "Main menu"
    }
  ]
}
{% endschema %}