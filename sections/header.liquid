{% comment %}
  Section Header "Lunetier" - Version Améliorée
  Features:
  - Mode recherche avec barre slide-down
  - Icône compte utilisateur
  - Tiroir mobile fonctionnel avec JavaScript
  - Design PC 100% préservé
{% endcomment %}

<div class="lunetier-header-wrapper" id="HeaderWrapper-{{ section.id }}">
  <div class="lunetier-container">
    
    <!-- LOGO -->
    <a href="{{ routes.root_url }}" class="lunetier-logo" aria-label="Retour à l'accueil">
      {%- if section.settings.logo != blank -%}
        {% render 'responsive-image',
          image: section.settings.logo,
          sizes: '(min-width: 768px) 150px, 100px',
          loading: 'eager',
          class: 'lunetier-logo-img',
          alt: section.settings.logo.alt | default: shop.name
        %}
      {%- else -%}
        {{ shop.name }}
      {%- endif -%}
    </a>

    <div class="lunetier-actions">
      <!-- DESKTOP MENU -->
      <nav class="lunetier-nav" role="navigation" aria-label="Menu principal">
        {%- for link in section.settings.menu.links -%}
          <a href="{{ link.url }}" class="lunetier-link">{{ link.title }}</a>
        {%- endfor -%}
      </nav>

      <!-- SEARCH BUTTON -->
      <button class="lunetier-icon-btn" id="SearchToggle-{{ section.id }}" aria-label="Ouvrir la recherche" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>

      <!-- ACCOUNT ICON -->
      <a href="{{ routes.account_url }}" class="lunetier-icon-btn" aria-label="Mon compte">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </a>

      <!-- CART ICON -->
      <a href="{{ routes.cart_url }}" class="lunetier-icon-btn" id="cart-icon-bubble" aria-label="Panier ({{ cart.item_count }} article{% if cart.item_count > 1 %}s{% endif %})">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        {%- if cart.item_count > 0 -%}
          <span class="lunetier-cart-count">{{ cart.item_count }}</span>
        {%- endif -%}
      </a>

      <!-- MOBILE BURGER TRIGGER -->
      <button class="lunetier-icon-btn lunetier-mobile-toggle" aria-label="Ouvrir le menu" id="MobileMenuTrigger-{{ section.id }}">
         <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
         </svg>
      </button>
    </div>

  </div>
</div>

<!-- SEARCH BAR SLIDE-DOWN -->
<div class="lunetier-search-bar" id="SearchBar-{{ section.id }}" role="search">
  <div class="lunetier-container">
    <form action="{{ routes.search_url }}" method="get" class="lunetier-search-form">
      <input
        type="text"
        name="q"
        placeholder="Rechercher un produit..."
        class="lunetier-search-input"
        id="SearchInput-{{ section.id }}"
        autocomplete="off"
        aria-label="Champ de recherche"
      >
      <input type="hidden" name="type" value="product">
      <button type="submit" class="lunetier-search-submit" aria-label="Lancer la recherche">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
      <button type="button" class="lunetier-search-close" id="SearchClose-{{ section.id }}" aria-label="Fermer la recherche">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </form>
  </div>
</div>

<!-- MOBILE DRAWER OVERLAY -->
<div class="lunetier-drawer-overlay" id="MobileDrawerOverlay-{{ section.id }}" role="presentation"></div>

<!-- MOBILE DRAWER -->
<div class="lunetier-drawer" id="MobileDrawer-{{ section.id }}" role="dialog" aria-modal="true" aria-label="Menu mobile">
  <div class="lunetier-drawer-header">
    <span class="lunetier-drawer-title">Menu</span>
    <button class="lunetier-drawer-close" id="MobileDrawerClose-{{ section.id }}" aria-label="Fermer le menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  
  <!-- SEARCH IN DRAWER (Mobile) -->
  <form action="{{ routes.search_url }}" method="get" class="lunetier-drawer-search">
    <input
      type="text"
      name="q"
      placeholder="Rechercher..."
      class="lunetier-drawer-search-input"
      autocomplete="off"
    >
    <input type="hidden" name="type" value="product">
  </form>

  <nav class="lunetier-drawer-nav" role="navigation" aria-label="Menu mobile">
    {%- for link in section.settings.menu.links -%}
      <a href="{{ link.url }}" class="lunetier-drawer-link">{{ link.title }}</a>
    {%- endfor -%}
    
    <!-- Additional Links -->
    <a href="{{ routes.account_url }}" class="lunetier-drawer-link lunetier-drawer-link--secondary">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem; vertical-align: middle;">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      Mon Compte
    </a>
    
    {% if shop.customer_accounts_enabled %}
      {% if customer %}
        <a href="{{ routes.account_logout_url }}" class="lunetier-drawer-link lunetier-drawer-link--secondary">
          Déconnexion
        </a>
      {% else %}
        <a href="{{ routes.account_login_url }}" class="lunetier-drawer-link lunetier-drawer-link--secondary">
          Connexion
        </a>
      {% endif %}
    {% endif %}
  </nav>
</div>

<!-- INLINE JAVASCRIPT FOR HEADER FUNCTIONALITY -->
<script>
(function() {
  const sectionId = '{{ section.id }}';
  const header = document.getElementById('HeaderWrapper-' + sectionId);
  const searchBar = document.getElementById('SearchBar-' + sectionId);
  const searchToggle = document.getElementById('SearchToggle-' + sectionId);
  const searchClose = document.getElementById('SearchClose-' + sectionId);
  const searchInput = document.getElementById('SearchInput-' + sectionId);
  const mobileMenuTrigger = document.getElementById('MobileMenuTrigger-' + sectionId);
  const mobileDrawer = document.getElementById('MobileDrawer-' + sectionId);
  const mobileDrawerOverlay = document.getElementById('MobileDrawerOverlay-' + sectionId);
  const mobileDrawerClose = document.getElementById('MobileDrawerClose-' + sectionId);

  // === SCROLL HEADER EFFECT ===
  let lastScrollY = window.scrollY;
  let ticking = false;

  function updateHeader() {
    if (window.scrollY > 50) {
      header.classList.add('is-scrolled');
    } else {
      header.classList.remove('is-scrolled');
    }
    ticking = false;
  }

  function requestTick() {
    if (!ticking) {
      window.requestAnimationFrame(updateHeader);
      ticking = true;
    }
  }

  window.addEventListener('scroll', requestTick, { passive: true });

  // === SEARCH BAR TOGGLE ===
  if (searchToggle && searchBar && searchClose && searchInput) {
    searchToggle.addEventListener('click', function() {
      const isOpen = searchBar.classList.contains('is-open');
      
      if (isOpen) {
        searchBar.classList.remove('is-open');
        searchToggle.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      } else {
        searchBar.classList.add('is-open');
        searchToggle.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
        setTimeout(function() {
          searchInput.focus();
        }, 300);
      }
    });

    searchClose.addEventListener('click', function() {
      searchBar.classList.remove('is-open');
      searchToggle.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    });

    // Close on ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && searchBar.classList.contains('is-open')) {
        searchBar.classList.remove('is-open');
        searchToggle.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }
    });
  }

  // === MOBILE DRAWER TOGGLE ===
  if (mobileMenuTrigger && mobileDrawer && mobileDrawerOverlay && mobileDrawerClose) {
    function openDrawer() {
      mobileDrawer.classList.add('is-open');
      mobileDrawerOverlay.classList.add('is-open');
      document.body.style.overflow = 'hidden';
      mobileMenuTrigger.setAttribute('aria-label', 'Fermer le menu');
    }

    function closeDrawer() {
      mobileDrawer.classList.remove('is-open');
      mobileDrawerOverlay.classList.remove('is-open');
      document.body.style.overflow = '';
      mobileMenuTrigger.setAttribute('aria-label', 'Ouvrir le menu');
    }

    mobileMenuTrigger.addEventListener('click', function() {
      if (mobileDrawer.classList.contains('is-open')) {
        closeDrawer();
      } else {
        openDrawer();
      }
    });

    mobileDrawerClose.addEventListener('click', closeDrawer);
    mobileDrawerOverlay.addEventListener('click', closeDrawer);

    // Close on ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && mobileDrawer.classList.contains('is-open')) {
        closeDrawer();
      }
    });
  }

  // Initial check
  updateHeader();
})();
</script>

{% schema %}
{
  "name": "Header Lunetier",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo Image"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 50,
      "max": 250,
      "step": 10,
      "default": 100,
      "unit": "px",
      "label": "Largeur du logo"
    },
    {
      "type": "link_list",
      "id": "menu",
      "default": "main-menu",
      "label": "Menu principal"
    }
  ]
}
{% endschema %}
