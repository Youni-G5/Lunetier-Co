{% comment %}
  Section Header "Lunetier" - Isolation ComplÃ¨te
  Mode PC : PARFAIT - Ne pas toucher
  Mode Mobile : Tiroir 100% isolÃ© des conflits
{% endcomment %}

<div class="lunetier-header-wrapper" id="HeaderWrapper-{{ section.id }}">
  <div class="lunetier-container">
    
    <!-- LOGO -->
    <a href="{{ routes.root_url }}" class="lunetier-logo" aria-label="Retour Ã  l'accueil">
      {%- if section.settings.logo != blank -%}
        {% render 'responsive-image',
          image: section.settings.logo,
          sizes: '(min-width: 768px) 150px, 100px',
          loading: 'eager',
          class: 'lunetier-logo-img',
          alt: section.settings.logo.alt | default: shop.name
        %}
      {%- else -%}
        {{ shop.name }}
      {%- endif -%}
    </a>

    <div class="lunetier-actions">
      <!-- DESKTOP MENU -->
      <nav class="lunetier-nav" role="navigation" aria-label="Menu principal">
        {%- for link in section.settings.menu.links -%}
          <a href="{{ link.url }}" class="lunetier-link">{{ link.title }}</a>
        {%- endfor -%}
      </nav>

      <!-- SEARCH BUTTON (Desktop + Mobile) -->
      <button class="lunetier-icon-btn" id="SearchToggle-{{ section.id }}" aria-label="Ouvrir la recherche" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>

      <!-- ACCOUNT ICON (Desktop only) -->
      <a href="{{ routes.account_url }}" class="lunetier-icon-btn lunetier-account-desktop" aria-label="Mon compte">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </a>

      <!-- CART ICON (Desktop + Mobile) -->
      <a href="{{ routes.cart_url }}" class="lunetier-icon-btn" id="cart-icon-bubble" aria-label="Panier ({{ cart.item_count }} article{% if cart.item_count > 1 %}s{% endif %})">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        {%- if cart.item_count > 0 -%}
          <span class="lunetier-cart-count">{{ cart.item_count }}</span>
        {%- endif -%}
      </a>

      <!-- MOBILE BURGER TRIGGER -->
      <button class="lunetier-icon-btn lunetier-mobile-toggle" aria-label="Ouvrir le menu" id="MobileMenuTrigger-{{ section.id }}" data-lunetier-burger>
         <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
         </svg>
      </button>
    </div>

  </div>
</div>

<!-- SEARCH BAR SLIDE-DOWN (Desktop + Mobile) -->
<div class="lunetier-search-bar" id="SearchBar-{{ section.id }}" role="search">
  <div class="lunetier-search-container">
    <form action="{{ routes.search_url }}" method="get" class="lunetier-search-form">
      <input
        type="text"
        name="q"
        placeholder="Rechercher un produit..."
        class="lunetier-search-input"
        id="SearchInput-{{ section.id }}"
        autocomplete="off"
        aria-label="Champ de recherche"
      >
      <input type="hidden" name="type" value="product">
      <button type="submit" class="lunetier-search-submit" aria-label="Lancer la recherche">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
      <button type="button" class="lunetier-search-close" id="SearchClose-{{ section.id }}" aria-label="Fermer la recherche">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </form>
  </div>
</div>

<!-- MOBILE DRAWER OVERLAY -->
<div class="lunetier-drawer-overlay" id="MobileDrawerOverlay-{{ section.id }}" data-lunetier-overlay></div>

<!-- MOBILE DRAWER -->
<div class="lunetier-drawer" id="MobileDrawer-{{ section.id }}" data-lunetier-drawer>
  <div class="lunetier-drawer-header">
    <span class="lunetier-drawer-title">Menu</span>
    <button type="button" class="lunetier-drawer-close" id="MobileDrawerClose-{{ section.id }}" data-lunetier-close aria-label="Fermer le menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  
  <div class="lunetier-drawer-content">
    <!-- NAVIGATION LINKS -->
    <nav class="lunetier-drawer-nav">
      {%- for link in section.settings.menu.links -%}
        <a href="{{ link.url }}" class="lunetier-drawer-link" data-lunetier-link>{{ link.title }}</a>
      {%- endfor -%}
    </nav>

    <!-- DIVIDER -->
    <div class="lunetier-drawer-divider"></div>

    <!-- SECONDARY LINKS -->
    <div class="lunetier-drawer-secondary">
      <a href="{{ routes.account_url }}" class="lunetier-drawer-secondary-link" data-lunetier-link>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>Mon Compte</span>
      </a>

      {% if shop.customer_accounts_enabled %}
        {% if customer %}
          <a href="{{ routes.account_logout_url }}" class="lunetier-drawer-secondary-link" data-lunetier-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>DÃ©connexion</span>
          </a>
        {% else %}
          <a href="{{ routes.account_login_url }}" class="lunetier-drawer-secondary-link" data-lunetier-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
              <polyline points="10 17 15 12 10 7"></polyline>
              <line x1="15" y1="12" x2="3" y2="12"></line>
            </svg>
            <span>Connexion</span>
          </a>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<!-- JAVASCRIPT - ISOLÃ‰ DANS NAMESPACE -->
<script>
(function() {
  'use strict';
  
  // NAMESPACE COMPLET pour Ã©viter conflits
  const LunetierHeader = {
    sectionId: '{{ section.id }}',
    isDrawerOpen: false,
    isSearchOpen: false,
    elements: {},
    
    init: function() {
      console.log('ðŸŽ¯ Lunetier Header Init');
      this.cacheElements();
      this.bindEvents();
      this.updateHeader();
    },
    
    cacheElements: function() {
      this.elements = {
        header: document.getElementById('HeaderWrapper-' + this.sectionId),
        searchBar: document.getElementById('SearchBar-' + this.sectionId),
        searchToggle: document.getElementById('SearchToggle-' + this.sectionId),
        searchClose: document.getElementById('SearchClose-' + this.sectionId),
        searchInput: document.getElementById('SearchInput-' + this.sectionId),
        burgerBtn: document.querySelector('[data-lunetier-burger]'),
        drawer: document.querySelector('[data-lunetier-drawer]'),
        overlay: document.querySelector('[data-lunetier-overlay]'),
        closeBtn: document.querySelector('[data-lunetier-close]')
      };
      
      console.log('âœ… Elements cached:', {
        burger: !!this.elements.burgerBtn,
        drawer: !!this.elements.drawer,
        overlay: !!this.elements.overlay,
        close: !!this.elements.closeBtn
      });
    },
    
    bindEvents: function() {
      const self = this;
      
      // SCROLL HEADER
      let ticking = false;
      window.addEventListener('scroll', function() {
        if (!ticking) {
          window.requestAnimationFrame(function() {
            self.updateHeader();
            ticking = false;
          });
          ticking = true;
        }
      }, { passive: true });
      
      // SEARCH
      if (this.elements.searchToggle) {
        this.elements.searchToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          self.toggleSearch();
        });
      }
      
      if (this.elements.searchClose) {
        this.elements.searchClose.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          self.closeSearch();
        });
      }
      
      // DRAWER - USE CAPTURE PHASE ET DATA ATTRIBUTES
      if (this.elements.burgerBtn) {
        this.elements.burgerBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          console.log('ðŸ” Burger clicked');
          self.toggleDrawer();
        }, true); // CAPTURE PHASE
      }
      
      if (this.elements.closeBtn) {
        this.elements.closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          console.log('âŒ Close clicked');
          self.closeDrawer();
        }, true); // CAPTURE PHASE
      }
      
      if (this.elements.overlay) {
        this.elements.overlay.addEventListener('click', function(e) {
          // Protection double : vÃ©rifier si vraiment ouvert
          if (!self.isDrawerOpen) {
            console.log('âš ï¸ Overlay click ignored (drawer not fully open)');
            return;
          }
          
          e.preventDefault();
          e.stopImmediatePropagation();
          console.log('ðŸŒ‘ Overlay clicked');
          self.closeDrawer();
        }, true); // CAPTURE PHASE
      }
      
      // ESC KEY
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          if (self.isSearchOpen) {
            self.closeSearch();
          }
          if (self.isDrawerOpen) {
            self.closeDrawer();
          }
        }
      });
      
      // PREVENT CLICKS ON DRAWER FROM CLOSING
      if (this.elements.drawer) {
        this.elements.drawer.addEventListener('click', function(e) {
          // Si clic sur un lien, laisser passer
          if (e.target.closest('[data-lunetier-link]')) {
            console.log('ðŸ”— Link clicked, allowing navigation');
            return;
          }
          // Sinon, empÃªcher la propagation
          e.stopPropagation();
        });
      }
    },
    
    updateHeader: function() {
      if (!this.elements.header) return;
      
      if (window.scrollY > 50) {
        this.elements.header.classList.add('is-scrolled');
      } else {
        this.elements.header.classList.remove('is-scrolled');
      }
    },
    
    toggleSearch: function() {
      if (this.isSearchOpen) {
        this.closeSearch();
      } else {
        this.openSearch();
      }
    },
    
    openSearch: function() {
      if (!this.elements.searchBar) return;
      
      this.isSearchOpen = true;
      this.elements.searchBar.classList.add('is-open');
      this.elements.searchToggle.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
      
      const self = this;
      setTimeout(function() {
        if (self.elements.searchInput) {
          self.elements.searchInput.focus();
        }
      }, 300);
    },
    
    closeSearch: function() {
      if (!this.elements.searchBar) return;
      
      this.isSearchOpen = false;
      this.elements.searchBar.classList.remove('is-open');
      this.elements.searchToggle.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    },
    
    toggleDrawer: function() {
      if (this.isDrawerOpen) {
        this.closeDrawer();
      } else {
        this.openDrawer();
      }
    },
    
    openDrawer: function() {
      if (!this.elements.drawer || !this.elements.overlay) return;
      
      console.log('ðŸŸ¢ Opening drawer...');
      
      // Ajouter classes
      this.elements.drawer.classList.add('is-open');
      this.elements.overlay.classList.add('is-open');
      document.body.style.overflow = 'hidden';
      
      // DÃ©lai avant de marquer comme ouvert (Ã©vite propagation)
      const self = this;
      setTimeout(function() {
        self.isDrawerOpen = true;
        console.log('âœ… Drawer fully open');
      }, 150);
    },
    
    closeDrawer: function() {
      if (!this.elements.drawer || !this.elements.overlay) return;
      
      console.log('ðŸ”´ Closing drawer...');
      
      this.isDrawerOpen = false;
      this.elements.drawer.classList.remove('is-open');
      this.elements.overlay.classList.remove('is-open');
      document.body.style.overflow = '';
      
      console.log('âœ… Drawer closed');
    }
  };
  
  // INIT quand DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      LunetierHeader.init();
    });
  } else {
    LunetierHeader.init();
  }
  
  // Exposer pour debug
  window.LunetierHeader = LunetierHeader;
  
})();
</script>

{% schema %}
{
  "name": "Header Lunetier",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo Image"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 50,
      "max": 250,
      "step": 10,
      "default": 100,
      "unit": "px",
      "label": "Largeur du logo"
    },
    {
      "type": "link_list",
      "id": "menu",
      "default": "main-menu",
      "label": "Menu principal"
    }
  ]
}
{% endschema %}
